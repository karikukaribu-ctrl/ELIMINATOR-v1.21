<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ELIMINATOR</title>

  <style>
    /* ============================================================
      ELIMINATOR v1.25-stable (single-file)
      - 2 modes : pastel clair / pastel foncé
      - palettes saisons (nature, sans mauve)
      - menu haut sticky + effet vitré flou
      - hub central scrollable (pas figé), titre plus bas
      - barre de progression grande & contrastée (ocres/bordeaux)
      - pomodoro intégré sous la barre (même bloc)
      - panneaux gauche/droit redimensionnables
      - focus mode overlay (essentiel seulement)
      - tasks + import catégories + filtres + édition + pin + cible
      - kiffance surprises (banque cachée) + confetti + pollen
      - sets alignés + habitudes + humeur TCC + calendrier mois + stats + export texte
    ============================================================ */

    :root{
      --font: ui-rounded, "SF Pro Rounded","Segoe UI Rounded", system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

      --appW: min(1320px, 96vw);

      /* Shape (moins arrondi) */
      --radius: 10px;
      --radius2: 8px;
      --lineW: 1px;

      /* Panels */
      --leftW: 420px;
      --rightW: 560px;

      /* Big progress */
      --progressH: clamp(160px, 26vh, 340px);

      /* Glass */
      --blur: 16px;
      --shadowA: 0 18px 75px rgba(0,0,0,.14);
      --shadowB: 0 10px 34px rgba(0,0,0,.10);
      --ink: rgba(20,22,28,.20);

      /* Default Theme vars (overridden by JS applyTheme) */
      --bg: #FFF7EE;         /* blanc chaud ocre */
      --fg: #1A1815;
      --muted: rgba(26,24,21,.70);

      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.46);
      --line: rgba(26,24,21,.16);

      --accent: rgba(205,120,60,.28);
      --accent2: rgba(205,120,60,.68);

      --barA: rgba(205,120,60,.28);
      --barB: rgba(107,31,26,.78);  /* bordeaux/ocre contrast */

      --haloA: rgba(205,120,60,.16);
      --haloB: rgba(120,160,200,.14);

      --grain: .10;

      /* UI knobs */
      --density: 1;
      --haloOn: 1;
      --wobble: 1;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--fg);
      background: var(--bg);
      overflow-x:hidden;
    }

    /* ===== Background anime-ish ===== */
    .bgSky{
      position:fixed; inset:0;
      z-index:-10;
      background:
        radial-gradient(1200px 700px at 14% 12%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(1200px 700px at 80% 20%, rgba(0,0,0,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.24), transparent 50%),
        var(--bg);
      overflow:hidden;
    }
    .bgSky::after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      opacity: var(--grain);
      background-image:
        repeating-linear-gradient(0deg, rgba(0,0,0,.08) 0, rgba(0,0,0,.08) 1px, transparent 1px, transparent 3px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.04) 0, rgba(0,0,0,.04) 1px, transparent 1px, transparent 4px);
      mix-blend-mode: soft-light;
      filter: blur(.2px);
    }

    .cloudLayer{
      position:absolute; inset:-20vh -20vw;
      opacity:.55;
      pointer-events:none;
      transform: translate3d(0,0,0);
    }
    .clouds1{
      background:
        radial-gradient(240px 120px at 12% 18%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(320px 160px at 22% 24%, rgba(255,255,255,.55), transparent 62%),
        radial-gradient(420px 200px at 70% 20%, rgba(255,255,255,.55), transparent 64%),
        radial-gradient(260px 140px at 78% 28%, rgba(255,255,255,.62), transparent 62%);
      animation: drift1 42s linear infinite;
    }
    .clouds2{
      opacity:.38;
      background:
        radial-gradient(320px 160px at 18% 60%, rgba(255,255,255,.45), transparent 62%),
        radial-gradient(420px 200px at 38% 66%, rgba(255,255,255,.32), transparent 64%),
        radial-gradient(520px 240px at 82% 62%, rgba(255,255,255,.32), transparent 64%);
      animation: drift2 68s linear infinite;
    }
    @keyframes drift1{ 0%{ transform: translateX(-6%) translateY(0%);} 100%{ transform: translateX(6%) translateY(-2%);} }
    @keyframes drift2{ 0%{ transform: translateX(6%) translateY(2%);} 100%{ transform: translateX(-6%) translateY(0%);} }

    canvas#confettiCanvas{
      position:fixed; inset:0; pointer-events:none; z-index:200;
    }
    canvas#pollenCanvas{
      position:fixed; inset:0; pointer-events:none; z-index:5; opacity:.65;
    }

    /* ===== Layout ===== */
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: 14px 14px 26px;
      gap: 14px;
    }

    /* Topbar sticky glass */
    .topbar{
      width: var(--appW);
      position: sticky;
      top: 10px;
      z-index: 80;

      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;

      padding: calc(10px * var(--density)) calc(12px * var(--density));
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
    }
    .tb-left,.tb-right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; min-width:0; }
    .tb-right{ justify-content:flex-end; }

    .btn{
      border: var(--lineW) solid var(--line);
      background: transparent;
      color: var(--fg);
      border-radius: var(--radius2);
      padding: calc(8px * var(--density)) calc(10px * var(--density));
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      transition: transform 140ms ease, background 140ms ease, opacity 140ms ease;
    }
    .btn:hover{ background: rgba(0,0,0,.04); }
    .btn:active{ transform: translateY(1px); }
    .btn.icon{ width:40px; height:36px; display:grid; place-items:center; padding:0; font-family: var(--mono); }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: var(--lineW) solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
      white-space:nowrap;
    }

    /* Stage scrollable */
    .stage{
      width: var(--appW);
      flex:1;
      min-height: calc(100vh - 110px);
      position:relative;
    }

    /* Hub centered but scroll-safe: not fixed, not absolute */
    .hub{
      width: min(980px, 100%);
      margin: 0 auto;
      padding-bottom: 24px;
    }

    .card{
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      overflow:hidden;
      position:relative;
    }

    /* Halo */
    .halo{
      position:absolute; inset:-60% -30%;
      pointer-events:none;
      opacity: calc(.50 * var(--haloOn));
      background:
        radial-gradient(circle at 18% 34%, var(--barB), transparent 58%),
        radial-gradient(circle at 70% 30%, var(--accent2), transparent 60%),
        radial-gradient(circle at 50% 75%, rgba(255,255,255,.10), transparent 56%);
      filter: blur(2px);
      transform: rotate(8deg);
      animation: halo 2.8s ease-in-out infinite alternate;
    }
    @keyframes halo{
      0%{ transform: rotate(6deg) scale(1.02); opacity: calc(.42 * var(--haloOn)); }
      100%{ transform: rotate(10deg) scale(1.10); opacity: calc(.62 * var(--haloOn)); }
    }

    /* Title lower & centered */
    .hero{
      padding: 22px 14px 0; /* titre plus bas */
      text-align:center;
    }
    .title{
      font-weight: 950;
      letter-spacing:.06em;
      font-size: clamp(44px, 5.0vw, 78px);
      margin: 0 0 8px;
      text-shadow: 0 18px 50px rgba(0,0,0,.12);
      transform: translateZ(0);
    }
    body[data-wobble="1"] .title{
      animation: wobble 7s ease-in-out infinite;
    }
    @keyframes wobble{ 0%,100%{ transform: translateY(0) rotate(-.2deg);} 50%{ transform: translateY(2px) rotate(.3deg);} }

    .tagline{
      font-family: var(--mono);
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 12px;
    }

    /* Progress block (big) */
    .progressWrap{ padding: 14px; }
    .bar{
      height: var(--progressH);
      border-radius: calc(var(--radius) - 2px);
      border: var(--lineW) solid rgba(0,0,0,.22);
      background: rgba(0,0,0,.04);
      position:relative;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.12);
    }
    .barFill{
      position:absolute; inset:0;
      width:100%;
      background:
        radial-gradient(900px 260px at 22% 45%, var(--barB), transparent 62%),
        linear-gradient(90deg, var(--barA), transparent 82%);
      transition: width 260ms ease;
      filter: saturate(1.12);
    }
    .barPct{
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-family: var(--mono);
      font-size: clamp(14px, 2.0vw, 22px);
      text-shadow: 0 10px 30px rgba(0,0,0,.18);
      opacity:.94;
      pointer-events:none;
    }

    .pomoRow{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pomoClock{
      display:flex; align-items:baseline; gap:10px;
      user-select:none; cursor:pointer;
    }
    .pomoTime{ font-family: var(--mono); font-size: 22px; letter-spacing:.04em; }
    .pomoHint{ font-family: var(--mono); font-size: 12px; color: var(--muted); }
    .pomoBtns{ display:flex; gap:8px; flex-wrap:wrap; }

    .underLine{
      margin-top: 10px;
      text-align:center;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    /* Task area */
    .taskCard{ padding: 14px; border-top: var(--lineW) solid var(--line); }
    .taskName{
      font-weight: 950;
      font-size: clamp(26px, 3.2vw, 54px);
      text-align:center;
      margin: 10px 0 10px;
      line-height:1.06;
      word-break: break-word;
    }

    .chips{
      display:flex; flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      margin-bottom: 12px;
    }
    .chip{
      width: 18px; height: 18px;
      border-radius: 6px;
      border: var(--lineW) solid var(--line);
      background: rgba(0,0,0,.03);
      transition: transform 140ms ease, background 140ms ease;
    }
    .chip.on{ background: var(--accent2); }

    .actions{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      flex-wrap:wrap;
      margin: 8px 0 12px;
    }
    .mini{
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius2);
      background: transparent;
      box-shadow: var(--shadowB);
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
      display:flex; gap:8px; align-items:center;
      transition: transform 140ms ease, background 140ms ease;
      font-size: 13px;
    }
    .mini:hover{ background: rgba(0,0,0,.03); }
    .mini:active{ transform: translateY(1px) scale(.99); }
    .mini .ic{ font-family: var(--mono); font-size: 14px; }
    .mini small{ color: var(--muted); font-family: var(--mono); font-size: 12px; }

    .roulette{
      width: clamp(120px, 16vw, 190px);
      height: clamp(120px, 16vw, 190px);
      border-radius: 999px;
      border: var(--lineW) solid var(--line);
      background:
        radial-gradient(circle at 30% 30%, var(--glass2), transparent 60%),
        radial-gradient(circle at 70% 60%, var(--accent2), transparent 65%),
        linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: var(--shadowA);
      backdrop-filter: blur(var(--blur));
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition: transform 140ms ease;
    }
    .roulette:active{ transform: translateY(1px) scale(.99); }
    .roulette::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:999px;
      border: 1px dashed rgba(0,0,0,.18);
      opacity:.8;
    }
    .rouletteText{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.10em;
      opacity:.92;
    }
    .spin{ animation: spin 860ms cubic-bezier(.08,.92,.20,1) 1; }
    @keyframes spin{ 0%{ transform: rotate(0deg);} 100%{ transform: rotate(1080deg);} }

    .bigAction{
      min-width: clamp(220px, 30vw, 360px);
      padding: 14px 16px;
      border-radius: var(--radius2);
      border: var(--lineW) solid var(--line);
      background: linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: var(--shadowA);
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:center; gap:12px;
      transition: transform 140ms ease, background 140ms ease;
    }
    .bigAction:hover{ background: rgba(0,0,0,.03); }
    .bigAction:active{ transform: translateY(1px) scale(.99); }
    .bigAction .em{ font-family: var(--mono); font-size: 18px; }
    .bigAction .label{ display:flex; flex-direction:column; line-height:1.12; align-items:center; }
    .bigAction .label b{ font-size: 14px; font-weight: 950; }
    .bigAction .label span{ font-size: 12px; color: var(--muted); font-family: var(--mono); }

    .belowList{
      margin-top: 12px;
      display:none;
      padding: 10px 12px;
      border-top: var(--lineW) solid var(--line);
    }
    .belowList.show{ display:block; }

    .listHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .rows{
      display:flex; flex-direction:column; gap:8px;
    }
    .rowTask{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 10px;
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.02);
    }
    .rowTask .t{
      flex:1; min-width:0;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      font-size: 13px;
    }
    .rowTask .m{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .rowTask .tools{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .toolBtn{
      border: var(--lineW) solid var(--line);
      background: transparent;
      color: var(--fg);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor:pointer;
      font-family: var(--mono);
    }
    .toolBtn:hover{ background: rgba(0,0,0,.03); }

    /* ===== Side panels ===== */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      display:none;
      z-index:90;
    }
    .panel{
      position:fixed; top:0; bottom:0;
      background: var(--glass);
      border: var(--lineW) solid var(--line);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      z-index:100;
      display:flex;
      flex-direction:column;
      width: min(var(--leftW), 94vw);
      transform: translateX(-110%);
      transition: transform 220ms ease;
    }
    .panel.right{
      right:0; left:auto;
      width: min(var(--rightW), 94vw);
      transform: translateX(110%);
    }
    .panel.open{ transform: translateX(0); }
    .backdrop.show{ display:block; }

    .panelTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-bottom: var(--lineW) solid var(--line);
    }
    .panelTop .ttl{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.04em;
    }
    .panelBody{ padding: 12px; overflow:auto; }
    .resizer{
      position:absolute; top:0; bottom:0;
      width:12px;
      cursor: ew-resize;
      opacity:0;
    }
    .panel.left .resizer{ right:-6px; }
    .panel.right .resizer{ left:-6px; }
    .panel:hover .resizer{ opacity:1; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding: 10px 12px 0; }
    .tab{
      padding: 7px 9px;
      border-radius: var(--radius2);
      border: var(--lineW) solid var(--line);
      cursor:pointer;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      user-select:none;
    }
    .tab:hover{ background: rgba(0,0,0,.03); }
    .tab.active{
      color: var(--fg);
      background: linear-gradient(180deg, var(--glass2), transparent);
      box-shadow: inset 0 0 0 1px var(--line);
    }

    .section{
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      background: rgba(0,0,0,.02);
      margin-top: 10px;
    }
    .section h3{
      margin:0 0 8px;
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
      font-weight: 900;
    }
    textarea,input,select{
      width:100%;
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius2);
      padding: 10px;
      background: transparent;
      color: var(--fg);
      font-size: 13px;
      outline:none;
      font-family: var(--font);
    }
    textarea{ min-height: 140px; resize:vertical; }

    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex:1; min-width: 160px; }

    .muted{ color: var(--muted); font-family: var(--mono); font-size: 12px; }
    .small{ color: var(--muted); font-family: var(--mono); font-size: 12px; }

    /* Dot selection chips (no emojis color) */
    .opt{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: var(--lineW) solid var(--line);
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      background: transparent;
      font-size: 13px;
      font-family: var(--mono);
    }
    .dot{
      width:10px; height:10px;
      border-radius: 999px;
      border: var(--lineW) solid var(--line);
      position:relative;
      display:block;
    }
    .opt.on .dot::after{
      content:"";
      position:absolute; inset:2px;
      border-radius:999px;
      background: rgba(0,0,0,.80);
    }

    /* ===== Modals ===== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      display:none;
      z-index:130;
    }
    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:140;
      padding: 18px;
      align-items:center;
      justify-content:center;
    }
    .modal.show{ display:flex; }
    .modalBack.show{ display:block; }
    .modalCard{
      width: min(1040px, 96vw);
      max-height: 90vh;
      overflow:auto;
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      padding: 12px;
      position:relative;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 6px 6px 10px;
      border-bottom: var(--lineW) solid var(--line);
      margin-bottom: 10px;
    }
    .modalHead .mh{ font-family: var(--mono); color: var(--muted); font-size: 12px; }

    /* ===== Focus overlay ===== */
    .focusOverlay{
      position:fixed; inset:0;
      display:none;
      z-index:160;
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(255,255,255,.18), transparent 62%),
        rgba(0,0,0,.36);
      backdrop-filter: blur(8px);
      padding: 16px;
      overflow:auto;
    }
    .focusOverlay.show{ display:block; }
    .focusCard{
      width: min(980px, 96vw);
      margin: 4vh auto;
      border: var(--lineW) solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadowA);
      overflow:hidden;
      position:relative;
    }
    .focusTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 10px 12px;
      border-bottom: var(--lineW) solid var(--line);
    }
    .focusBody{ padding: 14px; }
    .focusBigTask{
      font-weight: 950;
      font-size: clamp(30px, 4.2vw, 68px);
      line-height: 1.04;
      text-align:center;
      margin: 12px 0 8px;
    }
    .focusMini{
      display:flex; justify-content:center; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }

    @media (max-width: 560px){
      .btn{ font-size: 12px; }
      .toolBtn{ font-size: 11px; padding: 6px 9px; }
    }
  </style>
</head>

<body data-wobble="1">
  <div class="bgSky" aria-hidden="true">
    <div class="cloudLayer clouds1"></div>
    <div class="cloudLayer clouds2"></div>
  </div>

  <canvas id="pollenCanvas"></canvas>
  <canvas id="confettiCanvas"></canvas>

  <!-- LEFT PANEL -->
  <div class="backdrop" id="leftBack"></div>
  <aside class="panel left" id="leftPanel" aria-label="Menu gauche">
    <div class="resizer" id="leftResizer" title="Redimensionner"></div>
    <div class="panelTop">
      <div class="ttl">Menu</div>
      <button class="btn" id="leftClose">fermer</button>
    </div>
    <div class="tabs" id="leftTabs"></div>
    <div class="panelBody" id="leftBody"></div>
  </aside>

  <!-- RIGHT PANEL -->
  <div class="backdrop" id="rightBack"></div>
  <aside class="panel right" id="rightPanel" aria-label="Panneau droit">
    <div class="resizer" id="rightResizer" title="Redimensionner"></div>
    <div class="panelTop">
      <div class="ttl">Panneau</div>
      <button class="btn" id="rightClose">fermer</button>
    </div>
    <div class="tabs" id="rightTabs"></div>
    <div class="panelBody" id="rightBody"></div>
  </aside>

  <!-- MODAL BACKDROP -->
  <div class="modalBack" id="modalBack"></div>

  <!-- NOTES MODAL -->
  <div class="modal" id="notesModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">Notes</div>
        <div class="small">Clique dehors pour fermer</div>
      </div>
      <div class="section">
        <h3>Ajouter</h3>
        <textarea id="noteInput" placeholder="Une note courte. Pas une thèse."></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="noteAdd">ajouter</button>
          <button class="btn" id="noteClear">vider</button>
        </div>
      </div>
      <div class="section">
        <h3>Historique</h3>
        <div id="notesList" class="small"></div>
      </div>
    </div>
  </div>

  <!-- KIFF MODAL -->
  <div class="modal" id="kiffModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh" id="kiffTitle">Kiffance</div>
        <div class="small">Clique dehors pour fermer</div>
      </div>
      <div class="section">
        <h3>Surprise</h3>
        <div id="kiffMsg" style="font-size:16px; line-height:1.55;"></div>
        <div id="kiffSub" class="small" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- VICTORY MODAL -->
  <div class="modal" id="victoryModal">
    <div class="modalCard" style="min-height:min(68vh,720px); display:flex; flex-direction:column; justify-content:center; overflow:hidden;">
      <div class="halo" aria-hidden="true"></div>
      <div id="victoryTitle" style="font-size:clamp(26px,4.2vw,60px); font-weight:950; text-align:center; letter-spacing:.04em;"></div>
      <div id="victoryMsg" style="font-size:clamp(14px,1.8vw,22px); text-align:center; line-height:1.55; max-width:78ch; margin:12px auto;"></div>
      <div class="small" style="text-align:center;">Clique dehors pour fermer</div>
    </div>
  </div>

  <!-- TASK EDIT MODAL -->
  <div class="modal" id="taskEditModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">Éditer tâche</div>
        <div class="small">Clique dehors pour fermer</div>
      </div>
      <div id="taskEditBody"></div>
    </div>
  </div>

  <!-- SET EDIT MODAL -->
  <div class="modal" id="setEditModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">Éditer set</div>
        <div class="small">Clique dehors pour fermer</div>
      </div>
      <div id="setEditBody"></div>
    </div>
  </div>

  <!-- CALENDAR DAY MODAL -->
  <div class="modal" id="calendarModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh" id="calendarTitle">Jour</div>
        <div class="small">Clique dehors pour fermer</div>
      </div>
      <div id="calendarBody"></div>
    </div>
  </div>

  <!-- EXPORT MODAL -->
  <div class="modal" id="exportModal">
    <div class="modalCard">
      <div class="modalHead">
        <div class="mh">Export texte</div>
        <div class="small">Clique dehors pour fermer</div>
      </div>
      <div class="section">
        <h3>Rapport</h3>
        <div class="row" style="margin-bottom:8px">
          <button class="btn" id="expRefresh">rafraîchir</button>
          <button class="btn" id="expCopy">copier</button>
        </div>
        <textarea id="expOut" style="min-height:320px"></textarea>
      </div>
    </div>
  </div>

  <!-- FOCUS OVERLAY -->
  <div class="focusOverlay" id="focusOverlay">
    <div class="focusCard">
      <div class="halo" aria-hidden="true"></div>
      <div class="focusTop">
        <div class="small"><b>ELIMINATOR</b> · focus</div>
        <button class="btn" id="btnExitFocus">quitter</button>
      </div>
      <div class="focusBody">
        <div class="bar" style="height: clamp(180px, 28vh, 360px);">
          <div class="barFill" id="fBarFill" style="width:100%"></div>
          <div class="barPct" id="fBarPct">100%</div>
        </div>

        <div class="pomoRow">
          <div class="pomoClock" id="fPomoClick">
            <div class="pomoTime" id="fPomoTime">25:00</div>
            <div class="pomoHint" id="fPomoHint">pomodoro</div>
          </div>
          <div class="pomoBtns">
            <button class="btn" id="fPomoStart">start</button>
            <button class="btn" id="fPomoStop" style="display:none;">stop</button>
          </div>
        </div>

        <div class="focusBigTask" id="fTaskName">Aucune tâche</div>
        <div class="chips" id="fChips"></div>

        <div class="focusMini">
          <div class="mini" id="fUndo"><span class="ic">↶</span><small>retour</small></div>
          <div class="mini" id="fNotes"><span class="ic">✎</span><small>notes</small></div>
          <div class="mini" id="fPause"><span class="ic">⏸</span><small>pause</small></div>
          <div class="mini" id="fKiff"><span class="ic">✶</span><small>kiff</small></div>
          <div class="bigAction" id="fEto"><div class="em">/</div><div class="label"><b>dégommer</b><span>1 étorion</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="tb-left">
        <button class="btn icon" id="btnLeft" title="Menu">≡</button>

        <button class="btn" id="btnTheme" title="Mode visuel">☼ <span id="themeLbl">pastel clair</span></button>
        <button class="btn" id="btnSeason" title="Palette saison">✿ <span id="seasonLbl">automne</span></button>

        <button class="btn" id="btnFocus" title="Focus">◎ <span>focus</span></button>

        <span class="pill" id="hudPill">0/0 · 00:00</span>
      </div>

      <div class="tb-right">
        <button class="btn icon" id="btnExport" title="Export">⇩</button>
        <button class="btn icon" id="btnRight" title="Panneau">▦</button>
      </div>
    </header>

    <!-- STAGE -->
    <main class="stage">
      <div class="hub">
        <div class="card" id="mainCard">
          <div class="halo" aria-hidden="true"></div>

          <div class="hero">
            <div class="title" id="appTitle">ELIMINATOR</div>
            <div class="tagline" id="tagline">Tu avances. Le chaos signe l’armistice.</div>
          </div>

          <div class="progressWrap">
            <div class="bar" title="La barre part de 100% et diminue">
              <div class="barFill" id="barFill" style="width:100%"></div>
              <div class="barPct" id="barPct">100%</div>
            </div>

            <div class="pomoRow" id="pomoWrap">
              <div class="pomoClock" id="pomoClickZone" title="Cliquer pour régler">
                <div class="pomoTime" id="pomoTime">25:00</div>
                <div class="pomoHint" id="pomoHint">pomodoro prêt</div>
              </div>

              <div class="pomoBtns">
                <button class="btn" id="btnPomoToggle">masquer</button>
                <button class="btn" id="btnPomoStart">start</button>
                <button class="btn" id="btnPomoStop" style="display:none;">stop</button>
              </div>
            </div>

            <div class="underLine" id="underBarLine">Un pas. Une coupe nette. Rien ne discute.</div>
          </div>

          <div class="taskCard">
            <div class="taskName" id="taskName">Aucune tâche</div>
            <div class="chips" id="etorChips"></div>

            <div class="actions">
              <div class="mini" id="btnUndo" title="Annuler"><span class="ic">↶</span><small>retour</small></div>

              <div class="roulette" id="btnRoulette" title="Roulette">
                <div class="rouletteText">roulette</div>
              </div>

              <div class="bigAction" id="btnEto" title="Dégommer 1 étorion">
                <div class="em">/</div>
                <div class="label"><b>dégommer</b><span>1 étorion</span></div>
              </div>
            </div>

            <div class="actions" style="margin-top:0">
              <div class="mini" id="btnNotes"><span class="ic">✎</span><small>notes</small></div>
              <div class="mini" id="btnList"><span class="ic">≣</span><small>liste</small></div>
              <div class="mini" id="btnEdit"><span class="ic">⌁</span><small>éditer</small></div>
              <div class="mini" id="btnPause"><span class="ic">⏸</span><small>pause</small></div>
              <div class="mini" id="btnKiff"><span class="ic">✶</span><small>kiff</small></div>
            </div>

            <div class="belowList" id="belowList">
              <div class="listHead">
                <div class="small">liste en cours</div>
                <button class="btn" id="btnHideList">masquer</button>
              </div>
              <div class="rows" id="belowRows"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- PARTIE 2/2 JS à coller juste après -->

  <script>
/* ============================================================
   ELIMINATOR v1.25-stable — JS unique (no deps)
   Tout est aligné sur les IDs de la PARTIE 1/2.
============================================================ */

/* ===== Utils ===== */
const $ = (id)=>document.getElementById(id);
const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
const uid = ()=>Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36);
const nowISO = ()=>new Date().toISOString();
const pad2 = (n)=>String(n).padStart(2,"0");
const fmtMMSS = (ms)=>{
  const s = Math.max(0, Math.floor(ms/1000));
  return `${pad2(Math.floor(s/60))}:${pad2(s%60)}`;
};
const dayKey = (d=new Date())=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const escapeHTML = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
const prefersReduced = ()=>window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

/* ===== Storage ===== */
const LS_KEY = "eliminator_v125_stable";

/* ===== Themes: 2 modes + saisons (sans mauve) ===== */
const SEASONS = ["printemps","ete","automne","hiver"];
const THEMES = {
  printemps:{
    clair:{ bg:"#FFF7EE", fg:"#1A1815", mutedAlpha:.70, glass:"rgba(255,255,255,.74)", glass2:"rgba(255,255,255,.46)", line:"rgba(26,24,21,.16)",
            accent:"rgba(110,190,150,.28)", accent2:"rgba(110,190,150,.70)", barA:"rgba(110,190,150,.22)", barB:"rgba(180,110,20,.78)",
            haloA:"rgba(110,190,150,.16)", haloB:"rgba(255,185,90,.14)"},
    fonce:{ bg:"#111613", fg:"#F0FFF7", mutedAlpha:.72, glass:"rgba(18,26,21,.62)", glass2:"rgba(18,26,21,.38)", line:"rgba(240,255,247,.14)",
            accent:"rgba(110,190,150,.22)", accent2:"rgba(110,190,150,.52)", barA:"rgba(180,110,20,.20)", barB:"rgba(180,110,20,.70)",
            haloA:"rgba(110,190,150,.12)", haloB:"rgba(255,185,90,.10)"},
  },
  ete:{
    clair:{ bg:"#FFF8F0", fg:"#1A1815", mutedAlpha:.70, glass:"rgba(255,255,255,.72)", glass2:"rgba(255,255,255,.44)", line:"rgba(26,24,21,.16)",
            accent:"rgba(90,170,210,.24)", accent2:"rgba(90,170,210,.62)", barA:"rgba(255,185,90,.24)", barB:"rgba(180,110,20,.80)",
            haloA:"rgba(90,170,210,.14)", haloB:"rgba(255,185,90,.14)"},
    fonce:{ bg:"#0F141E", fg:"#F2F7FF", mutedAlpha:.72, glass:"rgba(20,28,44,.62)", glass2:"rgba(20,28,44,.38)", line:"rgba(242,247,255,.14)",
            accent:"rgba(90,170,210,.18)", accent2:"rgba(90,170,210,.44)", barA:"rgba(255,185,90,.18)", barB:"rgba(200,130,30,.72)",
            haloA:"rgba(90,170,210,.12)", haloB:"rgba(255,185,90,.10)"},
  },
  automne:{
    clair:{ bg:"#FFF7EE", fg:"#1A1815", mutedAlpha:.72, glass:"rgba(255,255,255,.72)", glass2:"rgba(255,255,255,.44)", line:"rgba(26,24,21,.17)",
            accent:"rgba(205,120,60,.28)", accent2:"rgba(205,120,60,.72)", barA:"rgba(205,120,60,.26)", barB:"rgba(107,31,26,.82)",
            haloA:"rgba(205,120,60,.16)", haloB:"rgba(120,160,200,.12)"},
    fonce:{ bg:"#17110C", fg:"#FFF2E6", mutedAlpha:.74, glass:"rgba(28,20,14,.62)", glass2:"rgba(28,20,14,.38)", line:"rgba(255,242,230,.14)",
            accent:"rgba(205,120,60,.20)", accent2:"rgba(205,120,60,.54)", barA:"rgba(205,120,60,.18)", barB:"rgba(138,42,34,.72)",
            haloA:"rgba(205,120,60,.12)", haloB:"rgba(120,160,200,.10)"},
  },
  hiver:{
    clair:{ bg:"#F7FBFF", fg:"#141B22", mutedAlpha:.70, glass:"rgba(255,255,255,.74)", glass2:"rgba(255,255,255,.46)", line:"rgba(20,27,34,.16)",
            accent:"rgba(120,160,200,.22)", accent2:"rgba(120,160,200,.58)", barA:"rgba(150,70,60,.22)", barB:"rgba(150,70,60,.76)",
            haloA:"rgba(120,160,200,.14)", haloB:"rgba(180,255,210,.10)"},
    fonce:{ bg:"#0E1418", fg:"#F2FDFF", mutedAlpha:.74, glass:"rgba(18,26,30,.62)", glass2:"rgba(18,26,30,.38)", line:"rgba(242,253,255,.14)",
            accent:"rgba(120,160,200,.18)", accent2:"rgba(120,160,200,.44)", barA:"rgba(150,70,60,.18)", barB:"rgba(200,130,30,.70)",
            haloA:"rgba(120,160,200,.10)", haloB:"rgba(180,255,210,.08)"},
  },
};

/* ===== State ===== */
const defaultState = {
  ui:{
    mode:"clair", season:"automne",
    leftW:420, rightW:560,
    reduceMotion:false
  },
  timer:{ startedAt:null, pausedAt:null, pausedTotal:0 },
  pomodoro:{ minutes:25, running:false, paused:false, endsAt:null, pausedLeftMs:null, visible:true },
  baseline:{ totalTasks:0, totalEtorions:0 },
  stats:{ tasksDone:0, etorionsDone:0 },
  tasks:[],
  currentTaskId:null,
  undo:[],
  notes:[],
  kiffance:{
    enabledBuckets:["5","10","15","25"],
    revealBank:false,
    bank:{ "5":[], "10":[], "15":[], "25":[] }
  },
  right:{ tab:"sets", calMonth:null, statsRange:"7d" },
  sets:{ list:[], selectedId:null },
  habits:[],
  mood:{ entries:[] },
  planner:{ items:[] },
  filters:{ activeCats:[] }
};

const deepAssign=(t,s)=>{
  for(const k in s){
    if(s[k] && typeof s[k]==="object" && !Array.isArray(s[k]) && t[k]) deepAssign(t[k], s[k]);
    else t[k]=s[k];
  }
};
const loadState=()=>{
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    const merged = structuredClone(defaultState);
    deepAssign(merged, parsed);
    return merged;
  }catch(_){ return structuredClone(defaultState); }
};
let state = loadState();
const saveState=()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(_){} };

/* ===== Theme apply ===== */
function applyTheme(){
  const season = THEMES[state.ui.season] ? state.ui.season : "automne";
  const mode = state.ui.mode==="fonce" ? "fonce" : "clair";
  const t = THEMES[season][mode];

  document.documentElement.style.setProperty("--bg", t.bg);
  document.documentElement.style.setProperty("--fg", t.fg);
  document.documentElement.style.setProperty("--muted", `rgba(${mode==="fonce" ? "242,253,255" : "26,24,21"}, ${t.mutedAlpha})`);
  document.documentElement.style.setProperty("--glass", t.glass);
  document.documentElement.style.setProperty("--glass2", t.glass2);
  document.documentElement.style.setProperty("--line", t.line);

  document.documentElement.style.setProperty("--accent", t.accent);
  document.documentElement.style.setProperty("--accent2", t.accent2);
  document.documentElement.style.setProperty("--barA", t.barA);
  document.documentElement.style.setProperty("--barB", t.barB);
  document.documentElement.style.setProperty("--haloA", t.haloA);
  document.documentElement.style.setProperty("--haloB", t.haloB);

  document.documentElement.style.setProperty("--leftW", `${clamp(state.ui.leftW,320,980)}px`);
  document.documentElement.style.setProperty("--rightW", `${clamp(state.ui.rightW,320,980)}px`);

  document.body.dataset.wobble = "1";

  if($("themeLbl")) $("themeLbl").textContent = (mode==="clair" ? "pastel clair" : "pastel foncé");
  if($("seasonLbl")) $("seasonLbl").textContent = season;
}

/* ===== Panels ===== */
function openPanel(which){
  const p = which==="left" ? $("leftPanel") : $("rightPanel");
  const b = which==="left" ? $("leftBack") : $("rightBack");
  if(!p||!b) return;
  p.classList.add("open");
  b.classList.add("show");
  if(which==="right") renderRight();
  if(which==="left") renderLeft();
}
function closePanel(which){
  const p = which==="left" ? $("leftPanel") : $("rightPanel");
  const b = which==="left" ? $("leftBack") : $("rightBack");
  if(!p||!b) return;
  p.classList.remove("open");
  b.classList.remove("show");
}
function initResizer(handleId, which){
  const h = $(handleId);
  if(!h) return;
  let dragging=false, sx=0, sw=0;

  const down=(x)=>{
    dragging=true; sx=x;
    sw = which==="left" ? state.ui.leftW : state.ui.rightW;
  };
  const move=(x)=>{
    if(!dragging) return;
    const dx = x - sx;
    if(which==="left") state.ui.leftW = clamp(sw + dx, 320, 980);
    else state.ui.rightW = clamp(sw - dx, 320, 980);
    applyTheme();
  };
  const up=()=>{
    if(!dragging) return;
    dragging=false;
    saveState();
  };

  h.addEventListener("mousedown",(e)=>{ e.preventDefault(); down(e.clientX); });
  window.addEventListener("mousemove",(e)=>move(e.clientX));
  window.addEventListener("mouseup", up);

  h.addEventListener("touchstart",(e)=>{ e.preventDefault(); down(e.touches[0].clientX); }, {passive:false});
  window.addEventListener("touchmove",(e)=>move(e.touches[0].clientX), {passive:true});
  window.addEventListener("touchend", up);
}

/* ===== Modals ===== */
function openModal(id){
  const back = $("modalBack"), m = $(id);
  if(!back||!m) return;
  back.classList.add("show");
  m.classList.add("show");
}
function closeAllModals(){
  $$(".modal").forEach(m=>m.classList.remove("show"));
  const back = $("modalBack");
  if(back) back.classList.remove("show");
}

/* ===== Timer global ===== */
function timerNowMs(){
  if(!state.timer.startedAt) return 0;
  const now = Date.now();
  const paused = state.timer.pausedTotal||0;
  const extra = state.timer.pausedAt ? (now - state.timer.pausedAt) : 0;
  return Math.max(0, now - state.timer.startedAt - paused - extra);
}
function toggleGlobalPause(){
  if(!state.timer.startedAt) state.timer.startedAt = Date.now();
  if(state.timer.pausedAt){
    state.timer.pausedTotal = (state.timer.pausedTotal||0) + (Date.now()-state.timer.pausedAt);
    state.timer.pausedAt = null;
  }else{
    state.timer.pausedAt = Date.now();
  }
  saveState();
  renderHUD();
}

/* ===== Confetti ===== */
const conf = { canvas:null, ctx:null, pieces:[], raf:null };
function setupCanvas(id){
  const c = $(id);
  if(!c) return null;
  const ctx = c.getContext("2d");
  const resize=()=>{
    const dpr = window.devicePixelRatio||1;
    c.width = Math.floor(innerWidth*dpr);
    c.height = Math.floor(innerHeight*dpr);
    c.style.width = innerWidth+"px";
    c.style.height = innerHeight+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  };
  addEventListener("resize", resize);
  resize();
  return {c,ctx};
}
function confettiBurst(power=1){
  if(state.ui.reduceMotion || prefersReduced()) return;
  if(!conf.ctx) return;
  const n = Math.floor(150*power);
  const cx = innerWidth/2, cy = innerHeight*0.28;
  for(let i=0;i<n;i++){
    conf.pieces.push({
      x:cx,y:cy,
      vx:(Math.random()-0.5)*10*power,
      vy:(Math.random()-0.9)*16*power,
      g:(0.28+Math.random()*0.22),
      s:2+Math.random()*4*power,
      life:80+Math.random()*70,
      rot:Math.random()*Math.PI,
      vr:(Math.random()-0.5)*0.35
    });
  }
  animateConfetti();
}
function animateConfetti(){
  if(conf.raf) return;
  const step=()=>{
    conf.ctx.clearRect(0,0,innerWidth,innerHeight);
    conf.pieces = conf.pieces.filter(p=>p.life>0);
    conf.ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--fg").trim() || "#000";
    conf.ctx.globalAlpha = 0.86;

    for(const p of conf.pieces){
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.life -= 1;

      conf.ctx.save();
      conf.ctx.translate(p.x,p.y);
      conf.ctx.rotate(p.rot);
      conf.ctx.fillRect(-p.s,-p.s,p.s*2,p.s*2);
      conf.ctx.restore();
    }
    if(conf.pieces.length) conf.raf = requestAnimationFrame(step);
    else{ cancelAnimationFrame(conf.raf); conf.raf=null; conf.ctx.clearRect(0,0,innerWidth,innerHeight); }
  };
  conf.raf = requestAnimationFrame(step);
}

/* ===== Pollen ===== */
const pollen = { canvas:null, ctx:null, seeds:[], raf:null };
function startPollen(){
  if(state.ui.reduceMotion || prefersReduced()) return;
  if(!pollen.ctx) return;
  const target=70;
  const make=()=>({
    x:Math.random()*innerWidth,
    y:Math.random()*innerHeight,
    r:0.8+Math.random()*2.2,
    a:0.08+Math.random()*0.18,
    vx:(Math.random()*0.18+0.04)*(Math.random()<0.5?-1:1),
    vy:(Math.random()*0.22+0.04),
    wob:Math.random()*Math.PI*2,
    wobv:0.006+Math.random()*0.012
  });
  while(pollen.seeds.length<target) pollen.seeds.push(make());

  const loop=()=>{
    if(state.ui.reduceMotion || prefersReduced()){ pollen.ctx.clearRect(0,0,innerWidth,innerHeight); pollen.raf=null; return; }
    pollen.ctx.clearRect(0,0,innerWidth,innerHeight);
    const halo = getComputedStyle(document.documentElement).getPropertyValue("--haloA").trim() || "rgba(200,160,80,.12)";
    pollen.ctx.fillStyle = halo;

    for(const s of pollen.seeds){
      s.wob += s.wobv;
      s.x += s.vx + Math.sin(s.wob)*0.25;
      s.y += s.vy;

      if(s.y > innerHeight+20){ s.y=-20; s.x=Math.random()*innerWidth; }
      if(s.x < -20) s.x = innerWidth+20;
      if(s.x > innerWidth+20) s.x = -20;

      pollen.ctx.globalAlpha = s.a;
      pollen.ctx.beginPath();
      pollen.ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      pollen.ctx.fill();
    }
    pollen.ctx.globalAlpha = 1;
    pollen.raf = requestAnimationFrame(loop);
  };

  if(!pollen.raf) pollen.raf = requestAnimationFrame(loop);
}

/* ===== Tasks import + model ===== */
function isAllCapsLine(line){
  const t = (line||"").trim();
  if(!t) return false;
  const hasLetters = /[A-Za-zÀ-ÖØ-öø-ÿ]/.test(t);
  if(!hasLetters) return false;
  return t === t.toUpperCase() && t.length <= 90;
}
function parseTaskLine(line){
  const raw = (line||"").trim();
  if(!raw) return null;
  const cleaned = raw.replace(/^[-*•\s]+/, "").trim();
  if(!cleaned) return null;

  let et = null;
  let title = cleaned;
  const m = cleaned.match(/^(.*?)(?:\s*[-–—]\s*|\s+)(\d+)\s*$/);
  if(m){ title=m[1].trim(); et=parseInt(m[2],10); }
  title = title.replace(/\s+/g," ").trim();
  if(!title) return null;
  if(et!==null) et = clamp(et,1,99);
  return { title, etorions: et };
}
function importFromInbox(text){
  const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let cat = "Inbox";
  const out = [];
  for(const line of lines){
    if(isAllCapsLine(line)){ cat=line.trim(); continue; }
    const p = parseTaskLine(line);
    if(!p) continue;
    out.push({
      id: uid(),
      title: p.title,
      cat,
      etorionsTotal: p.etorions ?? 1,
      etorionsLeft: p.etorions ?? 1,
      pinned:false,
      done:false,
      createdAt: nowISO(),
      doneAt:null
    });
  }
  return out;
}
const activeTasks=()=>state.tasks.filter(t=>!t.done);
const doneTasks=()=>state.tasks.filter(t=>t.done);
const getTask=(id)=>state.tasks.find(t=>t.id===id)||null;

function sortTasks(list){
  return [...list].sort((a,b)=>{
    if(a.pinned && !b.pinned) return -1;
    if(!a.pinned && b.pinned) return 1;
    return String(a.createdAt||"").localeCompare(String(b.createdAt||""));
  });
}
function ensureCurrentTask(){
  const list = activeTasks();
  if(list.length===0){ state.currentTaskId=null; return; }
  const cur = getTask(state.currentTaskId);
  if(!cur || cur.done){
    const pinned = list.find(t=>t.pinned);
    state.currentTaskId = (pinned || sortTasks(list)[0]).id;
  }
}
function recomputeBaseline(force=false){
  if(force || (state.baseline.totalTasks===0 && state.baseline.totalEtorions===0 && state.tasks.length>0)){
    const act = activeTasks();
    state.baseline.totalTasks = act.length;
    state.baseline.totalEtorions = act.reduce((a,t)=>a+(t.etorionsTotal||0),0);
  }
}
function computeProgress(){
  const baseT = state.baseline.totalTasks||0;
  const rem = activeTasks();
  const remT = rem.length;
  const pct = baseT<=0 ? 100 : clamp(Math.round((remT/baseT)*100),0,100);
  return { baseT, remT, pct };
}

/* ===== Undo ===== */
function pushUndo(label){
  state.undo.unshift({
    label, at: Date.now(),
    payload: structuredClone({
      tasks: state.tasks,
      baseline: state.baseline,
      currentTaskId: state.currentTaskId,
      stats: state.stats
    })
  });
  state.undo = state.undo.slice(0,18);
  saveState();
}
function undo(){
  const snap = state.undo.shift();
  if(!snap) return;
  const p = snap.payload;
  state.tasks = p.tasks;
  state.baseline = p.baseline;
  state.currentTaskId = p.currentTaskId;
  state.stats = p.stats;
  saveState();
  renderAll();
}

/* ===== Actions ===== */
function completeTask(id){
  const t = getTask(id);
  if(!t || t.done) return;
  pushUndo("complete");
  t.done = true;
  t.doneAt = nowISO();
  state.stats.tasksDone = (state.stats.tasksDone||0)+1;
  confettiBurst(1.05);
  ensureCurrentTask();
  saveState();
  renderAll();
  if(activeTasks().length===0 && state.baseline.totalTasks>0) showVictory();
}
function deleteTask(id){
  const t = getTask(id);
  if(!t) return;
  pushUndo("delete");
  state.tasks = state.tasks.filter(x=>x.id!==id);
  recomputeBaseline(true);
  ensureCurrentTask();
  saveState();
  renderAll();
}
function degomme(){
  const t = getTask(state.currentTaskId);
  if(!t || t.done) return;
  pushUndo("etorion");
  t.etorionsLeft = clamp((t.etorionsLeft ?? t.etorionsTotal ?? 1)-1,0,99);
  state.stats.etorionsDone = (state.stats.etorionsDone||0)+1;
  if(t.etorionsLeft<=0) completeTask(t.id);
  saveState();
  renderAll();
}

/* ===== Pomodoro ===== */
function pomoLeftMs(){
  if(!state.pomodoro.running) return null;
  if(state.pomodoro.paused && typeof state.pomodoro.pausedLeftMs==="number") return state.pomodoro.pausedLeftMs;
  if(!state.pomodoro.endsAt) return null;
  return Math.max(0, state.pomodoro.endsAt - Date.now());
}
function pomoStart(){
  const min = clamp(parseInt(state.pomodoro.minutes,10)||25, 5, 90);
  state.pomodoro.minutes=min;
  state.pomodoro.running=true;
  state.pomodoro.paused=false;
  state.pomodoro.pausedLeftMs=null;
  state.pomodoro.endsAt = Date.now() + min*60*1000;
  saveState();
  renderPomodoro();
}
function pomoPauseToggle(){
  if(!state.pomodoro.running) return;
  if(!state.pomodoro.paused){
    state.pomodoro.paused=true;
    state.pomodoro.pausedLeftMs = pomoLeftMs() ?? (state.pomodoro.minutes*60*1000);
    state.pomodoro.endsAt=null;
  }else{
    state.pomodoro.paused=false;
    const left = clamp(state.pomodoro.pausedLeftMs||0, 0, 90*60*1000);
    state.pomodoro.endsAt = Date.now() + left;
    state.pomodoro.pausedLeftMs=null;
  }
  saveState();
  renderPomodoro();
}
function pomoStop(){
  state.pomodoro.running=false;
  state.pomodoro.paused=false;
  state.pomodoro.endsAt=null;
  state.pomodoro.pausedLeftMs=null;
  saveState();
  renderPomodoro();
}

/* ===== Taglines (mégalo fin) ===== */
const TAGLINES = [
  "Tu avances. Le chaos s’excuse en silence.",
  "Le royaume du ‘plus tard’ recule. Tu prends le terrain.",
  "Tu n’es pas pressé : tu es inévitable.",
  "Les tâches négocient. Tu refuses poliment.",
  "L’ordre se reconstitue autour de toi. C’est suspect, mais agréable."
];
function setTagline(){
  const el = $("tagline");
  if(!el) return;
  if(!el.textContent.trim() || Math.random()<0.22){
    el.textContent = TAGLINES[Math.floor(Math.random()*TAGLINES.length)];
  }
}

/* ===== Victory ===== */
const VICTORY_LINES = [
  "Mission accomplie. Le chaos signe l’armistice.",
  "La forteresse des obligations est tombée. Bannière plantée.",
  "Les dragons administratifs ont fui vers leurs dossiers.",
  "Ton nom sera gravé sur la Tablette du Flow. En lettres propres.",
  "La réalité a plié le genou. Marche en silence triomphal."
];
function showVictory(){
  $("victoryTitle").textContent = "Victoire totale";
  $("victoryMsg").textContent = VICTORY_LINES[Math.floor(Math.random()*VICTORY_LINES.length)];
  confettiBurst(1.8);
  openModal("victoryModal");
}

/* ===== Kiffance seed + pick ===== */
(function seedKiff(){
  const b = state.kiffance.bank;
  const empty = ["5","10","15","25"].every(k=>Array.isArray(b[k]) && b[k].length===0);
  if(!empty) return;
  b["5"] = [
    "Statue héroïque 20 secondes. Puis reprise royale.",
    "Bois un verre d’eau comme un druide qui valide ton destin.",
    "Étire nuque/épaules 60 secondes. Ailes dépliées.",
    "Range 10 objets. Le 11e est un portail.",
    "Respire 5 cycles lents. Tu es une montagne."
  ];
  b["10"] = [
    "Fenêtre 2 min + eau + retour net.",
    "Micro-marche 6 min sans téléphone. Reviens avec une intention.",
    "Snack simple sans écran. Tu es un moine guerrier."
  ];
  b["15"] = [
    "Marche 10 + eau 5. Pas de scroll, pas de négociation.",
    "Respiration 4-6 (6 min) + étirements (6 min) + reprise (3 min)."
  ];
  b["25"] = [
    "Pause ‘Ghibli’: lumière, thé, silence, puis retour (sans téléphone).",
    "Micro-sieste 15–20 + eau + reprise lente."
  ];
  saveState();
})();
function pickKiff(){
  const enabled = state.kiffance.enabledBuckets.filter(k=>state.kiffance.bank[k]?.length);
  if(!enabled.length) return null;
  const bucket = enabled[Math.floor(Math.random()*enabled.length)];
  const arr = state.kiffance.bank[bucket];
  return { bucket, text: arr[Math.floor(Math.random()*arr.length)] };
}
function showKiff(){
  const p = pickKiff();
  if(!p){ $("kiffTitle").textContent="Kiffance"; $("kiffMsg").textContent="Banque vide."; $("kiffSub").textContent=""; openModal("kiffModal"); return; }
  $("kiffTitle").textContent = `Kiffance (${p.bucket} min)`;
  $("kiffMsg").textContent = p.text;
  $("kiffSub").textContent = "Pause courte, surprise, puis retour au monde.";
  openModal("kiffModal");
}

/* ===== Notes ===== */
function renderNotes(){
  const host = $("notesList");
  if(!host) return;
  const items = state.notes.slice(0,60);
  host.innerHTML = items.length ? items.map(n=>`<div style="padding:6px 0;border-bottom:1px solid var(--line)">${escapeHTML(n.text)}<div class="small">${escapeHTML(n.at)}</div></div>`).join("") : `<div class="small">Aucune note.</div>`;
}
function addNote(){
  const txt = ($("noteInput").value||"").trim();
  if(!txt) return;
  state.notes.unshift({ id:uid(), text:txt, at: new Date().toLocaleString() });
  $("noteInput").value="";
  saveState();
  renderNotes();
}
function clearNotes(){
  state.notes = [];
  saveState();
  renderNotes();
}

/* ===== Render HUD + main ===== */
function renderHUD(){
  recomputeBaseline(false);
  ensureCurrentTask();
  const p = computeProgress();
  const time = fmtMMSS(timerNowMs());
  $("hudPill").textContent = `${p.remT}/${p.baseT} · ${time}`;
}
function renderProgress(){
  recomputeBaseline(false);
  const p = computeProgress();
  $("barFill").style.width = `${p.pct}%`;
  $("barPct").textContent = `${p.pct}%`;
  $("fBarFill").style.width = `${p.pct}%`;
  $("fBarPct").textContent = `${p.pct}%`;
}
function renderTask(){
  ensureCurrentTask();
  const t = getTask(state.currentTaskId);
  if(!t){
    $("taskName").textContent = "Aucune tâche";
    $("etorChips").innerHTML = "";
    $("fTaskName").textContent = "Aucune tâche";
    $("fChips").innerHTML = "";
    return;
  }
  $("taskName").textContent = t.title;
  $("fTaskName").textContent = t.title;
  const total = t.etorionsTotal||1;
  const left = (typeof t.etorionsLeft==="number") ? t.etorionsLeft : total;

  const chipsHTML = Array.from({length: total}, (_,i)=>`<span class="chip ${i<left?"on":""}"></span>`).join("");
  $("etorChips").innerHTML = chipsHTML;
  $("fChips").innerHTML = chipsHTML;
}
function selectedCats(){
  const all = Array.from(new Set(state.tasks.map(t=>t.cat||"Inbox"))).sort();
  const act = state.filters.activeCats||[];
  return act.length ? act : all;
}
function renderBelowList(){
  const host = $("belowRows");
  const cats = selectedCats();
  const list = sortTasks(activeTasks().filter(t=>cats.includes(t.cat||"Inbox"))).slice(0,80);

  if(!list.length){
    host.innerHTML = `<div class="small">Aucune tâche (ou filtre vide).</div>`;
    return;
  }
  host.innerHTML = list.map(t=>{
    const et = t.etorionsTotal||1;
    const left = t.etorionsLeft ?? et;
    return `
      <div class="rowTask">
        <div class="t">${escapeHTML(t.title)}</div>
        <div class="m">${left}/${et}</div>
        <div class="tools">
          <button class="toolBtn" data-a="pin" data-id="${t.id}">${t.pinned?"priorité":"prioriser"}</button>
          <button class="toolBtn" data-a="go" data-id="${t.id}">cibler</button>
          <button class="toolBtn" data-a="edit" data-id="${t.id}">éditer</button>
          <button class="toolBtn" data-a="done" data-id="${t.id}">finir</button>
          <button class="toolBtn" data-a="del" data-id="${t.id}">supprimer</button>
        </div>
      </div>
    `;
  }).join("");

  $$(".toolBtn", host).forEach(b=>{
    b.onclick=()=>{
      const id=b.getAttribute("data-id");
      const a=b.getAttribute("data-a");
      const t=getTask(id);
      if(!t) return;
      pushUndo("listAction");
      if(a==="pin") t.pinned=!t.pinned;
      if(a==="go") state.currentTaskId=id;
      if(a==="done") completeTask(id);
      if(a==="del") deleteTask(id);
      if(a==="edit") openTaskEditor(id);
      saveState();
      renderAll();
    };
  });
}
function renderPomodoro(){
  const wrap = $("pomoWrap");
  wrap.style.display = state.pomodoro.visible ? "" : "none";
  const left = pomoLeftMs();

  if(!state.pomodoro.running){
    $("pomoTime").textContent = `${pad2(state.pomodoro.minutes)}:00`;
    $("pomoHint").textContent = "pomodoro prêt";
    $("btnPomoStart").textContent = "start";
    $("btnPomoStop").style.display = "none";
  }else{
    $("pomoTime").textContent = fmtMMSS(left||0);
    $("pomoHint").textContent = state.pomodoro.paused ? "pomodoro (pause)" : "pomodoro (en cours)";
    $("btnPomoStart").textContent = state.pomodoro.paused ? "reprendre" : "pause";
    $("btnPomoStop").style.display = "";
  }

  // focus mirror
  if(!state.pomodoro.running){
    $("fPomoTime").textContent = `${pad2(state.pomodoro.minutes)}:00`;
    $("fPomoHint").textContent = "pomodoro";
    $("fPomoStart").textContent = "start";
    $("fPomoStop").style.display = "none";
  }else{
    $("fPomoTime").textContent = fmtMMSS(left||0);
    $("fPomoHint").textContent = state.pomodoro.paused ? "pomodoro (pause)" : "pomodoro";
    $("fPomoStart").textContent = state.pomodoro.paused ? "reprendre" : "pause";
    $("fPomoStop").style.display = "";
  }
}
function renderAll(){
  applyTheme();
  setTagline();
  renderHUD();
  renderProgress();
  renderTask();
  renderPomodoro();
  if($("belowList").classList.contains("show")) renderBelowList();
}

/* ===== Task editor ===== */
function openTaskEditor(id){
  const t = getTask(id);
  if(!t) return;
  const body = $("taskEditBody");
  body.innerHTML = `
    <div class="section">
      <h3>modifier</h3>
      <div class="row">
        <input id="teTitle" value="${escapeHTML(t.title)}" placeholder="Titre">
        <input id="teCat" value="${escapeHTML(t.cat||"")}" placeholder="Catégorie">
      </div>
      <div class="row">
        <input id="teTotal" type="number" min="1" max="99" value="${t.etorionsTotal||1}">
        <input id="teLeft" type="number" min="0" max="99" value="${t.etorionsLeft ?? (t.etorionsTotal||1)}">
      </div>
      <div class="row">
        <button class="btn" id="teSave">enregistrer</button>
        <button class="btn" id="teCancel">annuler</button>
      </div>
    </div>
  `;
  $("teSave").onclick=()=>{
    pushUndo("edit");
    t.title = ($("teTitle").value||"").trim() || t.title;
    t.cat = ($("teCat").value||"").trim() || t.cat;
    t.etorionsTotal = clamp(parseInt($("teTotal").value,10)||1,1,99);
    t.etorionsLeft = clamp(parseInt($("teLeft").value,10)||t.etorionsTotal,0,99);
    saveState();
    closeAllModals();
    renderAll();
  };
  $("teCancel").onclick=()=>closeAllModals();
  openModal("taskEditModal");
}

/* ===== Export texte ===== */
function exportReport(){
  recomputeBaseline(false);
  const p = computeProgress();
  const done = p.baseT - p.remT;

  const lines=[];
  lines.push("ELIMINATOR — export texte");
  lines.push(`Date: ${dayKey()}`);
  lines.push(`Tâches: ${done} faites / ${p.baseT} total (reste ${p.remT})`);
  lines.push(`Étorions: ${state.stats.etorionsDone||0} faits (baseline ${state.baseline.totalEtorions||0})`);
  lines.push(`Temps actif: ${fmtMMSS(timerNowMs())}`);
  lines.push("");

  const act = sortTasks(activeTasks());
  const byCat={};
  act.forEach(t=>{ const c=(t.cat||"Inbox").trim()||"Inbox"; (byCat[c] ||= []).push(t); });
  Object.keys(byCat).sort().forEach(cat=>{
    lines.push(cat);
    byCat[cat].forEach(t=>{
      const et=t.etorionsTotal||1;
      const left=t.etorionsLeft ?? et;
      lines.push(`- ${t.title} (${left}/${et})${t.pinned?" [priorité]":""}`);
    });
    lines.push("");
  });

  const doneList = doneTasks().slice().sort((a,b)=>String(b.doneAt||"").localeCompare(String(a.doneAt||""))).slice(0,20);
  if(doneList.length){
    lines.push("Finies (dernier 20)");
    doneList.forEach(t=>lines.push(`- ${t.title}`));
  }
  return lines.join("\n");
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }catch(_){ return false; }
}

/* ===== Left panel (Menu) ===== */
const LEFT_TABS = [
  { key:"inbox", label:"inbox" },
  { key:"prefs", label:"préférences" },
  { key:"kiff", label:"kiffance" }
];
function renderLeft(){
  const tabs = $("leftTabs");
  const body = $("leftBody");
  if(!tabs||!body) return;

  state.ui.leftTab = state.ui.leftTab || "inbox";
  tabs.innerHTML = LEFT_TABS.map(t=>`<button class="tab ${state.ui.leftTab===t.key?"active":""}" data-tab="${t.key}">${t.label}</button>`).join("");
  $$(".tab", tabs).forEach(b=>{
    b.onclick=()=>{
      state.ui.leftTab = b.getAttribute("data-tab");
      saveState();
      renderLeft();
    };
  });

  if(state.ui.leftTab==="inbox"){
    body.innerHTML = `
      <div class="section">
        <h3>import</h3>
        <div class="small">Catégories en MAJ. Exemple: CONSULT · tâche - 6</div>
        <textarea id="inboxText" placeholder="HOSPITALIER&#10;Patient 1 - 6&#10;Patient 2 - 4&#10;&#10;CONSULT&#10;Appeler X - 2"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="inboxImportBtn">importer</button>
          <button class="btn" id="baselineResetBtn">reset baseline</button>
        </div>
      </div>

      <div class="section">
        <h3>filtres catégories</h3>
        <div id="catBox" class="row"></div>
        <div class="small" style="margin-top:8px">Si aucun filtre sélectionné : tout est inclus.</div>
      </div>

      <div class="section">
        <h3>nettoyage</h3>
        <div class="row">
          <button class="btn" id="clearDoneBtn">supprimer finies</button>
          <button class="btn" id="wipeAllBtn">tout effacer</button>
        </div>
      </div>
    `;

    $("inboxImportBtn").onclick=()=>{
      const items = importFromInbox(($("inboxText").value||""));
      if(!items.length) return;
      pushUndo("import");
      state.tasks.push(...items);
      recomputeBaseline(true);
      ensureCurrentTask();
      $("inboxText").value="";
      saveState();
      renderAll();
    };
    $("baselineResetBtn").onclick=()=>{
      pushUndo("baseline");
      recomputeBaseline(true);
      saveState();
      renderAll();
    };
    $("clearDoneBtn").onclick=()=>{
      pushUndo("clearDone");
      state.tasks = state.tasks.filter(t=>!t.done);
      recomputeBaseline(true);
      ensureCurrentTask();
      saveState();
      renderAll();
    };
    $("wipeAllBtn").onclick=()=>{
      if(!confirm("Tout effacer ?")) return;
      pushUndo("wipeAll");
      state.tasks=[];
      state.baseline={totalTasks:0,totalEtorions:0};
      state.currentTaskId=null;
      state.stats={tasksDone:0,etorionsDone:0};
      saveState();
      renderAll();
    };

    // category chips
    const cats = Array.from(new Set(state.tasks.map(t=>(t.cat||"Inbox").trim()||"Inbox"))).sort();
    const host = $("catBox");
    host.innerHTML = cats.length ? cats.map(c=>{
      const active = (state.filters.activeCats||[]).length===0 || (state.filters.activeCats||[]).includes(c);
      return `<button class="opt ${active?"on":""}" data-cat="${escapeHTML(c)}"><span class="dot"></span>${escapeHTML(c)}</button>`;
    }).join("") : `<div class="small">Aucune catégorie.</div>`;

    $$(".opt", host).forEach(b=>{
      b.onclick=()=>{
        const c = b.getAttribute("data-cat");
        const arr = state.filters.activeCats || (state.filters.activeCats=[]);
        const i = arr.indexOf(c);
        if(i>=0) arr.splice(i,1); else arr.push(c);
        saveState();
        renderAll();
        renderLeft();
        if($("belowList").classList.contains("show")) renderBelowList();
      };
    });
  }

  if(state.ui.leftTab==="prefs"){
    body.innerHTML = `
      <div class="section">
        <h3>mode visuel</h3>
        <div class="row">
          <button class="btn" id="prefMode">${state.ui.mode==="clair"?"passer foncé":"passer clair"}</button>
          <button class="btn" id="prefMotion">${(state.ui.reduceMotion||false)?"réduire motion: oui":"réduire motion: non"}</button>
        </div>
      </div>

      <div class="section">
        <h3>panneaux</h3>
        <div class="row">
          <input id="prefLeftW" type="number" min="320" max="980" value="${state.ui.leftW}">
          <input id="prefRightW" type="number" min="320" max="980" value="${state.ui.rightW}">
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="prefApplyPanels">appliquer</button>
        </div>
      </div>
    `;

    $("prefMode").onclick=()=>{
      state.ui.mode = state.ui.mode==="clair" ? "fonce" : "clair";
      saveState(); renderAll(); renderLeft();
    };
    $("prefMotion").onclick=()=>{
      state.ui.reduceMotion = !state.ui.reduceMotion;
      saveState();
      if(state.ui.reduceMotion){ if(pollen.ctx) pollen.ctx.clearRect(0,0,innerWidth,innerHeight); }
      else startPollen();
      renderLeft();
    };
    $("prefApplyPanels").onclick=()=>{
      state.ui.leftW = clamp(parseInt($("prefLeftW").value,10)||420, 320, 980);
      state.ui.rightW = clamp(parseInt($("prefRightW").value,10)||560, 320, 980);
      saveState(); applyTheme();
    };
  }

  if(state.ui.leftTab==="kiff"){
    body.innerHTML = `
      <div class="section">
        <h3>tirage</h3>
        <div class="row">
          <button class="btn" id="kiffPickBtn">surprise</button>
          <button class="btn" id="kiffRevealBtn">${state.kiffance.revealBank?"cacher banque":"voir banque"}</button>
        </div>
      </div>

      <div class="section">
        <h3>buckets actifs</h3>
        <div class="row" id="kiffBuckets"></div>
      </div>

      <div class="section" id="kiffBankBox" style="display:${state.kiffance.revealBank?"block":"none"}">
        <h3>banque (édition)</h3>
        <div class="small">Une ligne = une kiffance. Laisse “surprise” si tu veux ne pas les lire.</div>
        <div class="row">
          <textarea id="k5" placeholder="moins de 5 min">${(state.kiffance.bank["5"]||[]).join("\n")}</textarea>
          <textarea id="k10" placeholder="moins de 10 min">${(state.kiffance.bank["10"]||[]).join("\n")}</textarea>
        </div>
        <div class="row">
          <textarea id="k15" placeholder="moins de 15 min">${(state.kiffance.bank["15"]||[]).join("\n")}</textarea>
          <textarea id="k25" placeholder="plus long">${(state.kiffance.bank["25"]||[]).join("\n")}</textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="kiffSave">enregistrer</button>
        </div>
      </div>
    `;

    $("kiffPickBtn").onclick=showKiff;
    $("kiffRevealBtn").onclick=()=>{
      state.kiffance.revealBank = !state.kiffance.revealBank;
      saveState(); renderLeft();
    };

    const host = $("kiffBuckets");
    const buckets = ["5","10","15","25"];
    host.innerHTML = buckets.map(b=>{
      const on = state.kiffance.enabledBuckets.includes(b);
      return `<button class="opt ${on?"on":""}" data-b="${b}"><span class="dot"></span>${b} min</button>`;
    }).join("");
    $$(".opt", host).forEach(b=>{
      b.onclick=()=>{
        const k = b.getAttribute("data-b");
        const arr = state.kiffance.enabledBuckets;
        const i = arr.indexOf(k);
        if(i>=0) arr.splice(i,1); else arr.push(k);
        saveState(); renderLeft();
      };
    });

    if($("kiffSave")){
      $("kiffSave").onclick=()=>{
        state.kiffance.bank["5"] = ($("k5").value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        state.kiffance.bank["10"]= ($("k10").value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        state.kiffance.bank["15"]= ($("k15").value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        state.kiffance.bank["25"]= ($("k25").value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        saveState(); renderLeft();
      };
    }
  }
}

/* ===== Right panel (Sets/Habits/Mood/Calendar/Stats) — version stable minimaliste ===== */
/* Pour rester “sans bugger”, je garde une version fiable (pas énorme), mais complète. */
function ensureRightSeeds(){
  // Sets seed
  if(!state.sets.list.length){
    state.sets.list = [
      { id:uid(), title:"Set 1", unitName:"Patient", unitCount:4, items:["Voir","Note","Traitement","Dossier"], checks:{} },
      { id:uid(), title:"Set 2", unitName:"Patient", unitCount:6, items:["Voir","Note","Ordonnance","Dossier"], checks:{} }
    ];
    state.sets.selectedId = state.sets.list[0].id;
  }
  // Habits seed
  if(!state.habits.length){
    state.habits = [
      { id:uid(), name:"Eau", slots:8, checks:Array.from({length:8},()=>false) },
      { id:uid(), name:"Marche", slots:4, checks:Array.from({length:4},()=>false) },
      { id:uid(), name:"Lecture", slots:3, checks:Array.from({length:3},()=>false) }
    ];
  }
  saveState();
}
function renderRight(){
  ensureRightSeeds();

  const tabs = $("rightTabs"), body = $("rightBody");
  if(!tabs||!body) return;

  const tab = state.right.tab || "sets";
  const T = [
    ["sets","sets"],["habits","habitudes"],["mood","humeur"],["cal","calendrier"],["stats","stats"]
  ];
  tabs.innerHTML = T.map(([k,l])=>`<button class="tab ${tab===k?"active":""}" data-t="${k}">${l}</button>`).join("");
  $$(".tab", tabs).forEach(b=>{
    b.onclick=()=>{ state.right.tab=b.getAttribute("data-t"); saveState(); renderRight(); };
  });

  body.innerHTML = "";
  if(tab==="sets") body.appendChild(viewSets());
  if(tab==="habits") body.appendChild(viewHabits());
  if(tab==="mood") body.appendChild(viewMood());
  if(tab==="cal") body.appendChild(viewCalendar());
  if(tab==="stats") body.appendChild(viewStats());
}

/* --- Sets view (aligné vertical) --- */
function getSet(id){ return state.sets.list.find(s=>s.id===id)||null; }
function setCheckKey(u,i){ return `u${u}_i${i}`; }
function initSetDay(set, day=dayKey()){
  set.checks ||= {};
  set.checks[day] ||= {};
}
function viewSets(){
  const wrap = document.createElement("div");
  const day = dayKey();
  if(!state.sets.selectedId) state.sets.selectedId = state.sets.list[0]?.id || null;
  const set = getSet(state.sets.selectedId);

  wrap.innerHTML = `
    <div class="section">
      <h3>sélection</h3>
      <div class="row" id="setPickRow"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="setNew">nouveau</button>
        <button class="btn" id="setEdit">éditer</button>
      </div>
    </div>
    <div class="section" id="setCheckSection">
      <h3>checklist</h3>
      <div id="setCheckList" class="small"></div>
    </div>
  `;

  const pick = wrap.querySelector("#setPickRow");
  pick.innerHTML = state.sets.list.map(s=>{
    const on = s.id===state.sets.selectedId;
    return `<button class="opt ${on?"on":""}" data-id="${s.id}"><span class="dot"></span>${escapeHTML(s.title)}</button>`;
  }).join("");

  $$(".opt", pick).forEach(b=>{
    b.onclick=()=>{ state.sets.selectedId=b.getAttribute("data-id"); saveState(); renderRight(); };
  });

  wrap.querySelector("#setNew").onclick=()=>{
    const s = { id:uid(), title:`Set ${state.sets.list.length+1}`, unitName:"Patient", unitCount:3, items:["Voir","Note","Traitement","Dossier"], checks:{} };
    state.sets.list.push(s);
    state.sets.selectedId = s.id;
    saveState(); renderRight();
  };
  wrap.querySelector("#setEdit").onclick=()=>{
    openModal("setEditModal");
    renderSetEditor();
  };

  const host = wrap.querySelector("#setCheckList");
  if(!set){ host.textContent="Aucun set."; return wrap; }
  initSetDay(set, day);
  const checks = set.checks[day];

  let html="";
  for(let u=0; u<set.unitCount; u++){
    html += `<div style="padding:10px 0;border-bottom:1px solid var(--line)">
      <div style="font-weight:900;margin-bottom:6px">${escapeHTML(set.unitName)} ${u+1}</div>`;
    for(let i=0;i<set.items.length;i++){
      const k=setCheckKey(u,i);
      const on=!!checks[k];
      html += `<button class="opt ${on?"on":""}" data-u="${u}" data-i="${i}" style="margin:6px 0;width:100%;justify-content:flex-start">
        <span class="dot"></span>${escapeHTML(set.items[i])}
      </button>`;
    }
    html += `</div>`;
  }
  host.innerHTML = html;

  $$(".opt[data-u]", host).forEach(b=>{
    b.onclick=()=>{
      const u=parseInt(b.getAttribute("data-u"),10);
      const i=parseInt(b.getAttribute("data-i"),10);
      const key=setCheckKey(u,i);
      checks[key]=!checks[key];
      saveState(); renderRight();
    };
  });

  return wrap;
}
function renderSetEditor(){
  const host = $("setEditBody");
  const set = getSet(state.sets.selectedId);
  if(!host||!set) return;

  host.innerHTML = `
    <div class="section">
      <h3>édition</h3>
      <div class="row">
        <input id="seTitle" value="${escapeHTML(set.title)}" placeholder="Titre">
        <input id="seUnitName" value="${escapeHTML(set.unitName)}" placeholder="Nom unité">
      </div>
      <div class="row">
        <input id="seUnitCount" type="number" min="1" max="30" value="${set.unitCount}">
        <button class="btn" id="seReset">reset jour</button>
      </div>
      <textarea id="seItems" style="min-height:180px">${escapeHTML(set.items.join("\n"))}</textarea>
      <div class="row">
        <button class="btn" id="seSave">enregistrer</button>
        <button class="btn" id="seDelete">supprimer</button>
      </div>
    </div>
  `;
  $("seSave").onclick=()=>{
    set.title = ($("seTitle").value||"").trim() || set.title;
    set.unitName = ($("seUnitName").value||"").trim() || set.unitName;
    set.unitCount = clamp(parseInt($("seUnitCount").value,10)||set.unitCount,1,30);
    set.items = ($("seItems").value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean).slice(0,40);
    saveState(); closeAllModals(); renderRight();
  };
  $("seReset").onclick=()=>{
    const day = dayKey();
    set.checks ||= {};
    set.checks[day] = {};
    saveState(); renderRight();
  };
  $("seDelete").onclick=()=>{
    if(!confirm("Supprimer ce set ?")) return;
    state.sets.list = state.sets.list.filter(s=>s.id!==set.id);
    state.sets.selectedId = state.sets.list[0]?.id || null;
    saveState(); closeAllModals(); renderRight();
  };
}

/* --- Habits view --- */
function viewHabits(){
  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="section">
      <h3>habitudes</h3>
      <div class="small">Clique les points. Simple. Efficace. Impérial.</div>
      <div id="habList"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="habAdd">ajouter</button>
      </div>
    </div>
  `;
  const host = wrap.querySelector("#habList");
  host.innerHTML = state.habits.map(h=>{
    const chips = h.checks.map((c,i)=>`<button class="opt ${c?"on":""}" data-h="${h.id}" data-i="${i}" style="padding:6px 10px"><span class="dot"></span>${i+1}</button>`).join("");
    return `
      <div style="padding:10px 0;border-bottom:1px solid var(--line)">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div style="font-weight:900">${escapeHTML(h.name)}</div>
          <button class="toolBtn" data-del="${h.id}">supprimer</button>
        </div>
        <div class="row" style="margin-top:8px">${chips}</div>
      </div>
    `;
  }).join("");

  $$(".opt[data-h]", host).forEach(b=>{
    b.onclick=()=>{
      const hId=b.getAttribute("data-h");
      const i=parseInt(b.getAttribute("data-i"),10);
      const h=state.habits.find(x=>x.id===hId);
      if(!h) return;
      h.checks[i]=!h.checks[i];
      saveState(); renderRight();
    };
  });
  $$("[data-del]", host).forEach(b=>{
    b.onclick=()=>{
      const id=b.getAttribute("data-del");
      state.habits = state.habits.filter(x=>x.id!==id);
      saveState(); renderRight();
    };
  });

  wrap.querySelector("#habAdd").onclick=()=>{
    const name = prompt("Nom habitude (ex: eau) :","Eau");
    if(name===null) return;
    const slots = clamp(parseInt(prompt("Nombre de points (3 à 12) :","8")||"8",10),3,12);
    state.habits.unshift({ id:uid(), name:name.trim()||"Habitude", slots, checks:Array.from({length:slots},()=>false) });
    saveState(); renderRight();
  };

  return wrap;
}

/* --- Mood view (TCC click-based minimal) --- */
const EMOS=["Joie","Calme","Stress","Anxiété","Tristesse","Colère","Honte","Culpabilité","Fatigue","Frustration","Solitude","Irritabilité","Peur","Soulagement"];
const DIST=[ "Tout ou rien","Catastrophisme","Lecture de pensée","Doit/Il faut","Filtre négatif","Étiquetage","Raisonnement émotionnel","Surgénéralisation" ];
const NEEDS=["Repos","Sécurité","Clarté","Lien","Autonomie","Compétence","Reconnaissance","Protection","Sens"];
const ACTIONS=["Respiration 4-6 (2 min)","Ancrage 5-4-3-2-1 (1 min)","Micro-marche (3 min)","Hydratation + posture (1 min)","Écrire 3 lignes (faits/pensée/alt)"];

const EMO_MAP={
  "Anxiété": { thoughts:["Je vais rater","Ça va déraper","Je dois contrôler"], distortions:["Catastrophisme","Lecture de pensée","Doit/Il faut"], needs:["Sécurité","Clarté","Repos"], actions:["Respiration 4-6 (2 min)","Ancrage 5-4-3-2-1 (1 min)","Écrire 3 lignes (faits/pensée/alt)"] },
  "Stress": { thoughts:["Trop à faire","Je suis en retard","Je dois aller vite"], distortions:["Doit/Il faut","Tout ou rien","Filtre négatif"], needs:["Clarté","Repos","Autonomie"], actions:["Hydratation + posture (1 min)","Micro-marche (3 min)","Respiration 4-6 (2 min)"] },
  "Tristesse": { thoughts:["Ça ne sert à rien","Je suis seul","Je n’y arrive pas"], distortions:["Filtre négatif","Étiquetage","Surgénéralisation"], needs:["Lien","Sens","Repos"], actions:["Micro-marche (3 min)","Écrire 3 lignes (faits/pensée/alt)"] },
  "Colère": { thoughts:["C’est injuste","On abuse","Je dois réagir"], distortions:["Doit/Il faut","Tout ou rien"], needs:["Protection","Autonomie"], actions:["Respiration 4-6 (2 min)","Hydratation + posture (1 min)"] },
  "Fatigue": { thoughts:["Je suis vidé","Je ne peux pas"], distortions:["Tout ou rien"], needs:["Repos","Protection"], actions:["Hydratation + posture (1 min)","Micro-marche (3 min)"] }
};
function moodColor(emo,intensity){
  const t = clamp((intensity||0)/10,0,1);
  const base = ({
    "Joie":[244,214,140],"Calme":[168,214,196],"Stress":[235,196,160],"Anxiété":[240,186,168],
    "Tristesse":[170,190,220],"Colère":[220,160,150],"Honte":[210,175,190],"Culpabilité":[200,185,170],
    "Fatigue":[200,205,210],"Frustration":[225,180,160],"Solitude":[175,195,215],"Irritabilité":[230,175,150],
    "Peur":[210,185,150],"Soulagement":[180,220,190]
  }[emo]||[200,200,200]);
  const f = 0.82 - t*0.22;
  return `rgb(${Math.round(base[0]*f)},${Math.round(base[1]*f)},${Math.round(base[2]*f)})`;
}
function viewMood(){
  const wrap=document.createElement("div");
  const today=dayKey();
  const recent = (state.mood.entries||[]).slice(0,18);
  wrap.innerHTML = `
    <div class="section">
      <h3>humeur (tcc)</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px">
        ${recent.length? recent.map(e=>`<div title="${escapeHTML(e.emotion)} ${e.intensity}/10" style="width:18px;height:18px;border:1px solid var(--line);background:${moodColor(e.emotion,e.intensity)}"></div>`).join("") : `<div class="small">Aucune entrée récente.</div>`}
      </div>

      <div class="small">Clique. Enregistre. Zéro roman.</div>
      <div class="row" style="margin-top:10px">
        <select id="mEmo">${EMOS.map(e=>`<option>${e}</option>`).join("")}</select>
        <input id="mInt" type="range" min="0" max="10" value="5">
      </div>
      <div class="row">
        <select id="mThought"></select>
        <select id="mDist"></select>
      </div>
      <div class="row">
        <select id="mNeed"></select>
        <select id="mAct"></select>
      </div>
      <div class="row">
        <button class="btn" id="mSuggest">proposer</button>
        <button class="btn" id="mSave">enregistrer</button>
      </div>
      <div class="small" id="mAfter" style="margin-top:10px"></div>
    </div>

    <div class="section">
      <h3>aujourd’hui</h3>
      <div id="mToday"></div>
    </div>
  `;

  const fillOptions=()=>{
    const emo = wrap.querySelector("#mEmo").value;
    const sug = EMO_MAP[emo] || { thoughts:["Pensée automatique"], distortions:DIST, needs:NEEDS, actions:ACTIONS };
    wrap.querySelector("#mThought").innerHTML = sug.thoughts.map(x=>`<option>${escapeHTML(x)}</option>`).join("");
    wrap.querySelector("#mDist").innerHTML = sug.distortions.map(x=>`<option>${escapeHTML(x)}</option>`).join("");
    wrap.querySelector("#mNeed").innerHTML = sug.needs.map(x=>`<option>${escapeHTML(x)}</option>`).join("");
    wrap.querySelector("#mAct").innerHTML = sug.actions.map(x=>`<option>${escapeHTML(x)}</option>`).join("");
  };
  const renderToday=()=>{
    const list = (state.mood.entries||[]).filter(e=>e.day===today).slice(0,10);
    wrap.querySelector("#mToday").innerHTML = list.length? list.map(e=>`
      <div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid var(--line)">
        <span style="width:14px;height:14px;border:1px solid var(--line);background:${moodColor(e.emotion,e.intensity)}"></span>
        <span class="small">${escapeHTML(e.emotion)} ${e.intensity}/10 · ${escapeHTML(e.need||"")}</span>
      </div>
    `).join("") : `<div class="small">Aucune entrée.</div>`;
  };

  wrap.querySelector("#mEmo").onchange=fillOptions;
  fillOptions();
  renderToday();

  wrap.querySelector("#mSuggest").onclick=fillOptions;
  wrap.querySelector("#mSave").onclick=()=>{
    const emo = wrap.querySelector("#mEmo").value;
    const entry = {
      id:uid(), day:today, at:nowISO(),
      emotion: emo,
      intensity: parseInt(wrap.querySelector("#mInt").value,10)||0,
      thought: wrap.querySelector("#mThought").value,
      distortion: wrap.querySelector("#mDist").value,
      need: wrap.querySelector("#mNeed").value,
      action: wrap.querySelector("#mAct").value
    };
    state.mood.entries.unshift(entry);
    saveState();
    wrap.querySelector("#mAfter").textContent = `Proposition: ${entry.action} · Besoin: ${entry.need}`;
    renderRight();
  };

  return wrap;
}

/* --- Calendar (mois + plan) --- */
function monthKey(d=new Date()){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function planForDay(day){ return (state.planner.items||[]).filter(x=>x.day===day); }
function viewCalendar(){
  const wrap=document.createElement("div");
  state.right.calMonth ||= monthKey(new Date());
  const [yy,mm]=state.right.calMonth.split("-").map(n=>parseInt(n,10));
  const first=new Date(yy,mm-1,1);
  const startDow=(first.getDay()+6)%7;
  const daysInMonth=new Date(yy,mm,0).getDate();

  wrap.innerHTML = `
    <div class="section">
      <h3>calendrier</h3>
      <div class="row">
        <button class="btn" id="calPrev">préc</button>
        <div class="pill">${state.right.calMonth}</div>
        <button class="btn" id="calNext">suiv</button>
      </div>
      <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px"></div>
      <div class="small" style="margin-top:10px">Clique un jour pour planifier.</div>
    </div>
  `;

  const grid=wrap.querySelector("#calGrid");
  for(let i=0;i<startDow;i++){
    const d=document.createElement("div");
    d.style.height="44px";
    grid.appendChild(d);
  }
  for(let d=1; d<=daysInMonth; d++){
    const day = `${yy}-${pad2(mm)}-${pad2(d)}`;
    const plans = planForDay(day);
    const moods = state.mood.entries.filter(e=>e.day===day);
    const top = moods[0];
    const cell=document.createElement("button");
    cell.className="btn";
    cell.style.textAlign="left";
    cell.style.height="52px";
    cell.style.padding="8px";
    cell.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <b style="font-family:var(--mono);font-size:12px">${d}</b>
      <span style="width:10px;height:10px;border:1px solid var(--line);background:${top?moodColor(top.emotion,top.intensity):"transparent"}"></span>
    </div>
    <div class="small" style="margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${plans[0]?escapeHTML(plans[0].title):""}</div>`;
    cell.onclick=()=>openCalendarDay(day);
    grid.appendChild(cell);
  }

  wrap.querySelector("#calPrev").onclick=()=>{
    const cur=new Date(yy,mm-2,1);
    state.right.calMonth=monthKey(cur);
    saveState(); renderRight();
  };
  wrap.querySelector("#calNext").onclick=()=>{
    const cur=new Date(yy,mm,1);
    state.right.calMonth=monthKey(cur);
    saveState(); renderRight();
  };
  return wrap;
}
function openCalendarDay(day){
  $("calendarTitle").textContent = `Jour ${day}`;
  const host = $("calendarBody");
  const plans = planForDay(day);
  const moods = state.mood.entries.filter(e=>e.day===day);

  host.innerHTML = `
    <div class="section">
      <h3>planifier</h3>
      <div class="row">
        <input id="planTitle" placeholder="Tâche future">
        <input id="planMin" type="number" min="1" max="240" value="10">
      </div>
      <div class="row">
        <button class="btn" id="planAdd">ajouter</button>
      </div>
    </div>

    <div class="section">
      <h3>liste</h3>
      ${plans.length ? plans.map(p=>`
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;padding:6px 0;border-bottom:1px solid var(--line)">
          <div class="small">${escapeHTML(p.title)} (${p.minutes} min)</div>
          <button class="toolBtn" data-del="${p.id}">supprimer</button>
        </div>
      `).join("") : `<div class="small">Rien.</div>`}
    </div>

    <div class="section">
      <h3>humeur</h3>
      ${moods.slice(0,6).map(e=>`<div class="small" style="display:flex;gap:8px;align-items:center;padding:4px 0">
        <span style="width:12px;height:12px;border:1px solid var(--line);background:${moodColor(e.emotion,e.intensity)}"></span>
        ${escapeHTML(e.emotion)} ${e.intensity}/10
      </div>`).join("") || `<div class="small">Aucune entrée.</div>`}
    </div>
  `;

  $("planAdd").onclick=()=>{
    const title = ($("planTitle").value||"").trim();
    if(!title) return;
    const minutes = clamp(parseInt($("planMin").value,10)||10,1,240);
    state.planner.items.unshift({ id:uid(), day, title, minutes, createdAt:nowISO() });
    saveState();
    openCalendarDay(day);
  };
  $$("[data-del]", host).forEach(b=>{
    b.onclick=()=>{
      const id=b.getAttribute("data-del");
      state.planner.items = state.planner.items.filter(x=>x.id!==id);
      saveState();
      openCalendarDay(day);
    };
  });

  openModal("calendarModal");
}

/* --- Stats minimal (fiable) --- */
function viewStats(){
  const wrap=document.createElement("div");
  wrap.innerHTML = `
    <div class="section">
      <h3>stats</h3>
      <div class="small">Courbe: tâches finies par jour (7 jours).</div>
      <canvas id="statsCanvas" width="800" height="240" style="width:100%;height:auto;border:1px solid var(--line);border-radius:var(--radius2)"></canvas>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="statsExport">export texte</button>
        <button class="btn" id="statsCopy">copier</button>
      </div>
      <textarea id="statsOut" style="min-height:180px;margin-top:10px"></textarea>
    </div>
  `;
  setTimeout(()=>{
    drawStats(wrap.querySelector("#statsCanvas"));
    const out = wrap.querySelector("#statsOut");
    const refresh=()=>{ out.value = exportReport(); };
    refresh();
    wrap.querySelector("#statsExport").onclick=refresh;
    wrap.querySelector("#statsCopy").onclick=async()=>{
      const ok = await copyText(out.value);
      wrap.querySelector("#statsCopy").textContent = ok ? "copié" : "échec";
      setTimeout(()=>wrap.querySelector("#statsCopy").textContent="copier", 1200);
    };
  },0);
  return wrap;
}
function drawStats(canvas){
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const days=7;
  const today=new Date();
  const series=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(today); d.setDate(d.getDate()-i);
    const key=dayKey(d);
    const count=state.tasks.filter(t=>t.done && t.doneAt && String(t.doneAt).startsWith(key)).length;
    series.push(count);
  }
  const maxV=Math.max(1,...series);
  const W=canvas.width, H=canvas.height, pad=28;
  const innerW=W-pad*2, innerH=H-pad*2;

  ctx.globalAlpha=0.15;
  ctx.strokeStyle="#000";
  for(let i=0;i<=4;i++){
    const y=pad+innerH*(i/4);
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
  }
  ctx.globalAlpha=1;

  ctx.strokeStyle="#000"; ctx.lineWidth=2;
  ctx.beginPath();
  series.forEach((v,idx)=>{
    const x=pad+innerW*(idx/(series.length-1||1));
    const y=pad+innerH*(1-(v/maxV));
    if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.fillStyle="#000";
  series.forEach((v,idx)=>{
    const x=pad+innerW*(idx/(series.length-1||1));
    const y=pad+innerH*(1-(v/maxV));
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });
}

/* ===== Events wiring (main) ===== */
function bindEvents(){
  // panels
  $("btnLeft").onclick=()=>openPanel("left");
  $("leftClose").onclick=()=>closePanel("left");
  $("leftBack").onclick=()=>closePanel("left");

  $("btnRight").onclick=()=>openPanel("right");
  $("rightClose").onclick=()=>closePanel("right");
  $("rightBack").onclick=()=>closePanel("right");

  // theme toggle
  $("btnTheme").onclick=()=>{
    state.ui.mode = state.ui.mode==="clair" ? "fonce" : "clair";
    saveState();
    renderAll();
  };
  // season cycle
  $("btnSeason").onclick=()=>{
    const i = Math.max(0, SEASONS.indexOf(state.ui.season));
    state.ui.season = SEASONS[(i+1)%SEASONS.length];
    saveState();
    renderAll();
  };

  // focus
  $("btnFocus").onclick=()=>{
    $("focusOverlay").classList.add("show");
    renderAll();
  };
  $("btnExitFocus").onclick=()=>{
    $("focusOverlay").classList.remove("show");
  };

  // export
  $("btnExport").onclick=()=>{
    $("expOut").value = exportReport();
    openModal("exportModal");
  };
  $("expRefresh").onclick=()=>{ $("expOut").value = exportReport(); };
  $("expCopy").onclick=async()=>{
    const ok = await copyText($("expOut").value);
    $("expCopy").textContent = ok ? "copié" : "échec";
    setTimeout(()=>$("expCopy").textContent="copier", 1200);
  };

  // modal close
  $("modalBack").onclick=closeAllModals;
  $$(".modal").forEach(m=>{
    m.addEventListener("click",(e)=>{ if(e.target===m) closeAllModals(); });
  });

  // actions
  $("btnUndo").onclick=undo;
  $("btnRoulette").onclick=()=>{
    const el=$("btnRoulette");
    el.classList.remove("spin"); void el.offsetWidth; el.classList.add("spin");
    const list = sortTasks(activeTasks());
    if(!list.length) return;
    const pinned=list.filter(t=>t.pinned);
    const pool=pinned.length?pinned:list;
    const pick=pool[Math.floor(Math.random()*pool.length)];
    state.currentTaskId=pick.id;
    saveState(); renderAll();
  };
  $("btnEto").onclick=degomme;

  $("btnNotes").onclick=()=>{ renderNotes(); openModal("notesModal"); };
  $("noteAdd").onclick=addNote;
  $("noteClear").onclick=clearNotes;

  $("btnList").onclick=()=>{
    $("belowList").classList.toggle("show");
    if($("belowList").classList.contains("show")) renderBelowList();
  };
  $("btnHideList").onclick=()=>$("belowList").classList.remove("show");
  $("btnEdit").onclick=()=>{
    const t=getTask(state.currentTaskId);
    if(!t) return;
    openTaskEditor(t.id);
  };
  $("btnPause").onclick=()=>{
    toggleGlobalPause();
    $("btnPause").querySelector("small").textContent = state.timer.pausedAt ? "reprendre" : "pause";
  };
  $("btnKiff").onclick=showKiff;

  // pomodoro
  $("btnPomoToggle").onclick=()=>{
    state.pomodoro.visible = !state.pomodoro.visible;
    saveState();
    renderPomodoro();
  };
  $("btnPomoStart").onclick=()=>{
    if(!state.pomodoro.running) pomoStart();
    else pomoPauseToggle();
    renderPomodoro();
  };
  $("btnPomoStop").onclick=()=>{ pomoStop(); renderPomodoro(); };
  $("pomoClickZone").onclick=()=>{
    const v = prompt("Durée pomodoro (minutes 5..90) :", String(state.pomodoro.minutes||25));
    if(v===null) return;
    state.pomodoro.minutes = clamp(parseInt(v,10)||25,5,90);
    saveState(); renderPomodoro();
  };

  // focus mirror controls
  $("fUndo").onclick=undo;
  $("fEto").onclick=degomme;
  $("fNotes").onclick=()=>{ renderNotes(); openModal("notesModal"); };
  $("fPause").onclick=()=>{ toggleGlobalPause(); renderAll(); };
  $("fKiff").onclick=showKiff;

  $("fPomoStart").onclick=()=>{
    if(!state.pomodoro.running) pomoStart();
    else pomoPauseToggle();
    renderPomodoro();
  };
  $("fPomoStop").onclick=()=>{ pomoStop(); renderPomodoro(); };
  $("fPomoClick").onclick=$("pomoClickZone").onclick;

  // keyboard
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      closeAllModals();
      $("focusOverlay").classList.remove("show");
      closePanel("left");
      closePanel("right");
    }
  });
}

/* ===== Tick loop ===== */
let tick=null;
function startTick(){
  if(tick) return;
  tick=setInterval(()=>{
    renderHUD();
    if(state.pomodoro.running && !state.pomodoro.paused){
      const left = pomoLeftMs();
      if(left!==null && left<=0){
        pomoStop();
        renderPomodoro();
        showKiff(); // fin pomodoro => kiff
      }else{
        renderPomodoro();
      }
    }
    // focus progress mirror always
    if($("focusOverlay").classList.contains("show")) renderProgress();
  }, 500);
}

/* ===== Boot ===== */
(function boot(){
  if(!state.timer.startedAt) state.timer.startedAt = Date.now();

  // canvas init
  const c1=setupCanvas("confettiCanvas"); if(c1){ conf.canvas=c1.c; conf.ctx=c1.ctx; }
  const c2=setupCanvas("pollenCanvas"); if(c2){ pollen.canvas=c2.c; pollen.ctx=c2.ctx; }

  applyTheme();
  initResizer("leftResizer","left");
  initResizer("rightResizer","right");

  bindEvents();
  startPollen();
  startTick();
  renderAll();
})();
</script>

</body>
</html>
